from openai import OpenAI
import os
import json
import openpyxl
import xlsxwriter

from dotenv import load_dotenv, find_dotenv
_ = load_dotenv(find_dotenv())

client = OpenAI(
    # This is the default and can be omitted
    api_key=os.environ.get("OPENAI_API_KEY"),
)

def chat_completion (prompt):
    completion= client.chat.completions.create(
    messages=[
        {
            "role": "user",
            "content": prompt,
        }
    ],
    model="gpt-3.5-turbo")
    return completion.choices[0].message



textdata = openpyxl.load_workbook('DepressionText_parsed.xlsx')

# Get all the sheets in the workbook
sheets = textdata.sheetnames

#agelist: age, text
samples = []

# # Iterate through the sheets
# for sheet in sheets:
#     # Get the active worksheet
#     ws = textdata[sheet]
#     # Iterate through the rows in the worksheet
#     for row in ws.rows:
#         print(row[1].value , " " ,row[0].value)
#         samples.append([row[1].value,row[0].value])

# Iterate through specific sheet
ws = textdata[sheets[4]]
for row in ws.rows:
    #print(row[1].value , " " ,row[0].value)
    samples.append([row[1].value,row[0].value])

results = [['d','prediction','actual','reasoning']];
#d = predicted age - actual age. (aiming for 0)

for i in samples:

    if(i[0] == "age"):
        continue
    
    prompt = f"""Predict the age of the text delimited by triple backticks. The following is an example of a 17-year old in the blog dataset, the system predicted this to be from a 16.48-year-old:
I can’t sleep, but this time I have school tommorow, so I have to try I guess. My parents got all pissed at me today because I forgot how to do the homework [...]. Really mad, I ended it pissing off my mom and [...] NOTHING! Damn, when I’m at
my cousin’s I have no urge to use the computer like I do here, [...].
This example matches with important features determined by the system, containing references to school and parents, and usage of swearing and anger words.
The following are selected turns (T) by a 19-year old (system prediction: 17.37 years) in a conversation in the Fisher dataset.
T: yeah it’s too i just just freaked out [...]
T: that kinda sucks for them
T: they were they were like going crazy
[...]
T: it’s like against some law to like
The text has many informal words such as “kinda” and well as many occurrences of the word “like.”
This example is from a 19-year old from the cancer dataset. The system’s prediction was far off, estimating an age of 35.48.
Im very young and an athlete and I really do not want to look disfigured, especially when I work so hard to be fit. I know it sounds shallow, but Im young and hope to [...] my husband one day :) [...] My
grandmother died of breast cancer at 51, and my mother is currently dealing with a cancerous tumor on her ovaries. Besides explicit references to being “very young,”
the text is much more formal than typical texts, making it a hard example.Provide the predicted age in JSON format with the following keys: reasoning, predicted_age. predicted_age values should be in an integer format.
    ```{i[1]}``` 
    """

    
    response = chat_completion(prompt)
    data  = json.loads(response.content)
    reasoning = data['reasoning']
    if(data['predicted_age'] == None or data['predicted_age']=='N/A'):
        predicted_age = 0
    else:
        predicted_age = int(data['predicted_age'])
    actual_age = int(i[0])
    
    results.append([predicted_age-actual_age,predicted_age,actual_age,reasoning]);

    print(str(predicted_age==actual_age)+ " " + str(predicted_age) + " " + str(actual_age) + " " + reasoning)

workbook = xlsxwriter.Workbook('DataArchive.xlsx');
worksheet = workbook.add_worksheet("01242024-0")

r = 0;
c = 0;

for value in (results):
    print(value)
    worksheet.write(r,c,value[0]);
    worksheet.write(r,c+1,value[1]);       
    worksheet.write(r,c+2,value[2]);
    worksheet.write(r,c+3,value[3]);
    r += 1

workbook.close()