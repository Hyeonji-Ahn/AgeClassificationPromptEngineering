from openai import OpenAI
import os
import json
import openpyxl
import xlsxwriter

from dotenv import load_dotenv, find_dotenv
_ = load_dotenv(find_dotenv())

client = OpenAI(
    # This is the default and can be omitted
    api_key=os.environ.get("OPENAI_API_KEY"),
)

def chat_completion (prompt):
    completion= client.chat.completions.create(
    messages=[
        {
            "role": "user",
            "content": prompt,
        }
    ],
    model="gpt-3.5-turbo")
    return completion.choices[0].message



textdata = openpyxl.load_workbook('DepressionText_parsed.xlsx')

# Get all the sheets in the workbook
sheets = textdata.sheetnames

#agelist: age, text
samples = []

# # Iterate through the sheets
# for sheet in sheets:
#     # Get the active worksheet
#     ws = textdata[sheet]
#     # Iterate through the rows in the worksheet
#     for row in ws.rows:
#         print(row[1].value , " " ,row[0].value)
#         samples.append([row[1].value,row[0].value])

# Iterate through specific sheet
ws = textdata[sheets[0]]
for row in ws.rows:
    #print(row[1].value , " " ,row[0].value)
    samples.append([row[1].value,row[0].value])

results = (['d','prediction','actual','reasoning']);
#d = predicted age - actual age. (aiming for 0)

for i in samples:

    if(i[0] == "age"):
        continue
    
    prompt = f"""Predict the age of the text delimited by triple backticks and Provide them in JSON format with the following keys: reasoning, predicted_age. predicted_age values should be in an integer format.
    ```{i[1]}``` 
    """

    
    response = chat_completion(prompt)
    data  = json.loads(response.content)
    reasoning = data['reasoning']
    if(data['predicted_age'] is None):
        predicted_age = 0
    else:
        predicted_age = int(data['predicted_age'])
    actual_age = int(i[0])
    
    results.append([predicted_age-actual_age,predicted_age,actual_age,reasoning]);

    print(str(predicted_age==actual_age)+ " " + str(predicted_age) + " " + str(actual_age) + " " + reasoning)

workbook = xlsxwriter.Workbook('DataArchive.xlsx');
worksheet = workbook.add_worksheet("01162024")

r = 0;
c = 0;

for d,p,a,r in (results):
    worksheet.write(r,c,d);
    worksheet.write(r,c+1,d);
    worksheet.write(r,c+2,d);
    worksheet.write(r,c+3,d);
    r += 1

workbook.close()